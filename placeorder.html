<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Blanket Order | Seller Dashboard</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="sellersildebar.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .blanket-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .stock-low { color: #dc2626; }
        .stock-medium { color: #d97706; }
        .stock-high { color: #059669; }
        .main-content {
            margin-left: 16rem;
            width: calc(100% - 16rem);
        }
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            .sidebar-hidden {
                display: none;
            }
        }
        /* Modal styles */
        #all-blankets-modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <button id="mobile-menu-button" class="md:hidden p-2 text-gray-500 rounded-md hover:bg-gray-100">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="text-xl md:text-2xl font-bold text-gray-800 ml-2 md:ml-0">Place Blanket Order</h1>
            <div class="flex items-center space-x-4">
                <button class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                    <i class="fas fa-bell text-gray-600"></i>
                </button>
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-800 font-bold">S</div>
                    <span class="font-medium hidden sm:inline">Seller Account</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="px-4 py-6 sm:px-6 lg:px-8">
        <div class="max-w-6xl mx-auto">
    
            <!-- Customer Information -->
            <div id="customer-info-section" class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Customer Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="customer-name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="customer-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="customer-email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="customer-phone" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="customer-address" class="block text-sm font-medium text-gray-700 mb-1">Shipping Address</label>
                        <input type="text" id="customer-address" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
            </div>

            <!-- Blanket Selection -->
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-medium text-gray-900">Select Blankets</h2>
                    <div class="relative w-64">
                        <input type="text" placeholder="Search blankets..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" id="blanket-search">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <button id="view-all-blankets-btn" class="px-3 py-1 text-sm bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition">
                        <i class="fas fa-list mr-1"></i> View All Blankets
                    </button>
                </div>

                <!-- Blanket Inventory Status -->
                <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                        <p class="text-sm text-blue-700">
                            Inventory levels shown reflect available stock at your assigned distributor. 
                            <span class="font-medium">Red items</span> may require manufacturer production.
                        </p>
                    </div>
                </div>

                <!-- Blanket Catalog -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="blanket-catalog">
                    <!-- Blankets will be loaded here dynamically -->
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                        <p class="mt-2 text-gray-500">Loading blankets...</p>
                    </div>
                </div>

                <!-- Selected Blankets -->
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <h3 class="text-md font-medium text-gray-900 mb-3">Selected Blankets</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Blanket</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Qty</th>
                                        <th class="price px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody class="selected-blankets-body bg-white divide-y divide-gray-200">
                                    <!-- Blanket rows will be added here dynamically -->
                                    <tr>
                                        <td colspan="6" class="px-4 py-4 text-center text-sm text-gray-500">No blankets selected</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Details -->
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Order Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option>Standard (3-5 business days)</option>
                            <option>Express (1-2 business days)</option>
                            <option>Urgent (Additional fees may apply)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Distributor</label>
                        <select id="distributor-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Loading distributors...</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Special Instructions</label>
                        <textarea rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Any special packaging or delivery instructions..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Order Summary</h2>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="order-summary-count text-gray-600">Subtotal (0 items)</span>
                        <span class="order-summary-subtotal font-medium">Rs.0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Shipping</span>
                        <span class="font-medium order-summary-shipping">Rs.0.00</span>
                    </div>
                    <div class="border-t border-gray-200 pt-3 mt-3">
                        <div class="flex justify-between">
                            <span class="text-lg font-medium">Estimated Total</span>
                            <span class="text-gray-600 estimated-cost">Rs.0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Submission -->
            <div class="flex justify-between">
                <button class="px-6 py-2 border rounded-lg text-gray-700 hover:bg-gray-100 transition">
                    Cancel Order
                </button>
                <div class="space-x-3">
                    <button class="px-6 py-2 border border-indigo-600 text-indigo-600 rounded-lg hover:bg-indigo-50 transition">
                        Save Draft
                    </button>
                    <button class="submit-order-btn px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Submit to Distributor
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- All Blankets Modal -->
    <div id="all-blankets-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-11/12 md:w-3/4 lg:w-2/3 max-h-[80vh] overflow-y-auto relative p-6">
            <h2 class="text-xl font-semibold mb-4">All Blankets</h2>
            <div id="all-blankets-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                <!-- Cards will be injected here -->
            </div>
            <button id="close-modal-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let blankets = [];
        let allBlankets = [];

        // Helper functions
        function getStockClass(stock) {
            if (stock < 10) return 'stock-low';
            if (stock < 20) return 'stock-medium';
            return 'stock-high';
        }

        function showError(message, elementId = 'blanket-catalog') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.innerHTML = `
                <div class="col-span-3 text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-circle text-red-500 text-2xl"></i>
                    <p class="mt-2">${message}</p>
                    <button onclick="loadTopStockBlankets()" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                        Retry
                    </button>
                </div>
            `;
        }

        // Data loading functions
        async function loadTopStockBlankets() {
            try {
                const response = await fetch('http://127.0.0.1:5002/api/blankets/top-stock');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                blankets = data.data || data; // Handle both formats
                renderBlanketCatalog(blankets);
            } catch (error) {
                console.error('Error loading blankets:', error);
                showError(error.message);
            }
        }

        async function loadAllBlankets() {
            try {
                const response = await fetch('http://127.0.0.1:5002/api/blankets/all');
                if (!response.ok) {
                    throw new Error('Failed to fetch blanket data');
                }
                const data = await response.json();
                return data.data || data; // Handle both formats
            } catch (error) {
                console.error('Error loading all blankets:', error);
                throw error;
            }
        }

        async function loadDistributors() {
            try {
                const response = await fetch('http://127.0.0.1:5002/api/distributors');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const distributors = data.data || data; // Handle both formats
                const select = document.getElementById('distributor-select');
                
                select.innerHTML = '<option value="">Select a distributor</option>';
                
                distributors.forEach(distributor => {
                    const option = document.createElement('option');
                    option.value = distributor.id;
                    option.textContent = `${distributor.username} (${distributor.email})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading distributors:', error);
                const select = document.getElementById('distributor-select');
                select.innerHTML = '<option value="">Error loading distributors</option>';
            }
        }

        // Rendering functions
        function renderBlanketCatalog(blankets) {
            const catalog = document.getElementById('blanket-catalog');
            if (!catalog) return;
            
            catalog.innerHTML = '';
            
            blankets.forEach(blanket => {
                const stockClass = getStockClass(blanket.stock);
                
                catalog.innerHTML += `
                    <div class="blanket-card bg-white border rounded-lg p-4 transition">
                        <div class="flex items-start mb-3">
                            <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mr-4 overflow-hidden">
                                ${blanket.image ? 
                                    `<img src="${blanket.image}" alt="${blanket.name}" class="w-full h-full object-cover">` : 
                                    `<i class="fas fa-blanket text-gray-400 text-xl"></i>`}
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-900">${blanket.name}</h3>
                                <p class="text-sm text-gray-500">${blanket.color}</p>
                                <div class="flex items-center mt-1">
                                    <span class="text-xs font-medium ${stockClass}">In Stock: ${blanket.stock}</span>
                                    <span class="mx-2 text-gray-300">|</span>
                                    <span class="text-xs blanket-price" data-price="${blanket.price}">Rs.${blanket.price.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex border rounded-lg">
                                <button class="px-2 py-1 text-gray-600 hover:bg-gray-100 minus-btn">-</button>
                                <input type="number" value="0" min="0" class="w-10 text-center border-0 focus:ring-0 quantity-input">
                                <button class="px-2 py-1 text-gray-600 hover:bg-gray-100 plus-btn">+</button>
                            </div>
                            <button class="text-sm text-indigo-600 hover:text-indigo-800 font-medium check-availability-btn">
                                Check Availability
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // Add event listeners for quantity changes
            document.querySelectorAll('.minus-btn').forEach(btn => {
                btn.addEventListener('click', handleQuantityChange);
            });
            
            document.querySelectorAll('.plus-btn').forEach(btn => {
                btn.addEventListener('click', handleQuantityChange);
            });
            
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', handleQuantityChange);
            });
        }

        function updateSelectedBlanketsTable() {
            const tableBody = document.querySelector(".selected-blankets-body");
            tableBody.innerHTML = "";
            let selectedCount = 0;

            document.querySelectorAll(".blanket-card").forEach(card => {
                const quantity = parseInt(card.querySelector(".quantity-input")?.value || 0);
                if (quantity > 0) {
                    selectedCount++;
                    const name = card.querySelector("h3").textContent;
                    const price = parseFloat(card.querySelector(".blanket-price")?.dataset.price || "0");
                    const total = quantity * price;

                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="py-1">${name}</td>
                        <td class="py-1">${quantity}</td>
                        <td class="py-1">Rs.${price.toFixed(2)}</td>
                        <td class="py-1">Rs.${total.toFixed(2)}</td>
                        <td class="py-1 text-right"><button class="text-red-500 text-sm remove-btn">Remove</button></td>
                    `;
                    tableBody.appendChild(row);
                }
            });

            if (selectedCount === 0) {
                const emptyRow = document.createElement("tr");
                emptyRow.innerHTML = `
                    <td colspan="6" class="px-4 py-4 text-center text-sm text-gray-500">No blankets selected</td>
                `;
                tableBody.appendChild(emptyRow);
            }
        }

        function updateOrderSummary() {
            let subtotal = 0;
            let shippingCost = 200;
            let itemCount = 0;

            document.querySelectorAll(".blanket-card").forEach(card => {
                const quantity = parseInt(card.querySelector(".quantity-input").value);
                if (quantity > 0) {
                    itemCount += quantity;
                    const price = parseFloat(card.querySelector(".blanket-price").dataset.price);
                    subtotal += quantity * price;
                }
            });

            const estimatedTotal = subtotal + shippingCost;

            document.querySelector(".order-summary-subtotal").textContent = `Rs.${subtotal.toFixed(2)}`;
            document.querySelector(".order-summary-count").textContent = `Subtotal (${itemCount} items)`;
            document.querySelector(".order-summary-shipping").textContent = `Rs.${shippingCost.toFixed(2)}`;
            document.querySelector(".estimated-cost").textContent = `Rs.${estimatedTotal.toFixed(2)}`;

            updateSelectedBlanketsTable();
        }

        // Modal functions
        async function showAllBlanketsModal() {
            const modal = document.getElementById('all-blankets-modal');
            const grid = document.getElementById('all-blankets-grid');

            grid.innerHTML = `
                <div class="col-span-full text-center py-4">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-xl"></i>
                    <p class="mt-2 text-gray-500">Loading blankets...</p>
                </div>
            `;

            modal.classList.remove('hidden');

            try {
                allBlankets = await loadAllBlankets();

                if (allBlankets.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-4 text-gray-500">
                            No blankets found in inventory.
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = '';

                allBlankets.forEach(blanket => {
                    const stockClass = getStockClass(blanket.stock);

                    const card = document.createElement('div');
                    card.className = 'bg-gray-100 rounded-md p-4 shadow hover:bg-gray-200 transition';

                    card.innerHTML = `
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mr-4 overflow-hidden">
                            ${blanket.image ? 
                                `<img src="${blanket.image}" alt="${blanket.name}" class="w-full h-full object-cover">` : 
                                `<i class="fas fa-blanket text-gray-400 text-xl"></i>`}
                        </div>
                        <h3 class="text-lg font-semibold mb-1">${blanket.name}</h3>
                        <p class="text-sm text-gray-600">Color: ${blanket.color || '-'}</p>
                        <p class="text-sm text-gray-600">Size: ${blanket.size || '-'}</p>
                        <p class="text-sm ${stockClass}">Stock: ${blanket.stock}</p>
                        <p class="text-sm font-semibold mt-2">Rs.${parseFloat(blanket.price).toFixed(2)}</p>
                        <div class="flex items-center justify-between mt-3">
                            <div class="flex border rounded-lg">
                                <button class="px-2 py-1 text-gray-600 hover:bg-gray-100 minus-btn">-</button>
                                <input type="number" value="0" min="0" class="w-10 text-center border-0 focus:ring-0 quantity-input">
                                <button class="px-2 py-1 text-gray-600 hover:bg-gray-100 plus-btn">+</button>
                            </div>
                            <button class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded text-sm select-blanket-btn" data-id="${blanket.id}">
                                Select
                            </button>
                        </div>
                    `;

                    grid.appendChild(card);
                });

                // Add event listeners for modal buttons
                document.querySelectorAll('.select-blanket-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const blanketId = parseInt(this.getAttribute('data-id'));
                        const blanket = allBlankets.find(b => b.id === blanketId);
                        if (blanket) {
                            addBlanketToCatalog(blanket);
                            modal.classList.add('hidden');
                        }
                    });
                });

            } catch (error) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-4 text-red-500">
                        Error loading blankets: ${error.message}
                    </div>
                `;
            }
        }

        function addBlanketToCatalog(blanket) {
            // Check if blanket already exists in catalog
            const existingBlankets = Array.from(document.querySelectorAll('.blanket-card h3'));
            const alreadyExists = existingBlankets.some(el => el.textContent === blanket.name);
            
            if (alreadyExists) return;

            const catalog = document.getElementById('blanket-catalog');
            const stockClass = getStockClass(blanket.stock);
            
            const newCard = document.createElement('div');
            newCard.className = 'blanket-card bg-white border rounded-lg p-4 transition';
            newCard.innerHTML = `
                <div class="flex items-start mb-3">
                    <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mr-4 overflow-hidden">
                        ${blanket.image ? 
                            `<img src="${blanket.image}" alt="${blanket.name}" class="w-full h-full object-cover">` : 
                            `<i class="fas fa-blanket text-gray-400 text-xl"></i>`}
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-900">${blanket.name}</h3>
                        <p class="text-sm text-gray-500">${blanket.color}</p>
                        <div class="flex items-center mt-1">
                            <span class="text-xs font-medium ${stockClass}">In Stock: ${blanket.stock}</span>
                            <span class="mx-2 text-gray-300">|</span>
                            <span class="text-xs blanket-price" data-price="${blanket.price}">Rs.${blanket.price.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex border rounded-lg">
                        <button class="px-2 py-1 text-gray-600 hover:bg-gray-100 minus-btn">-</button>
                        <input type="number" value="0" min="0" class="w-10 text-center border-0 focus:ring-0 quantity-input">
                        <button class="px-2 py-1 text-gray-600 hover:bg-gray-100 plus-btn">+</button>
                    </div>
                    <button class="text-sm text-indigo-600 hover:text-indigo-800 font-medium check-availability-btn">
                        Check Availability
                    </button>
                </div>
            `;

            // Add event listeners to new card
            newCard.querySelector('.minus-btn').addEventListener('click', handleQuantityChange);
            newCard.querySelector('.plus-btn').addEventListener('click', handleQuantityChange);
            newCard.querySelector('.quantity-input').addEventListener('change', handleQuantityChange);

            catalog.appendChild(newCard);
            blankets.push(blanket);
        }

        // Event handlers
        function handleQuantityChange(e) {
            const input = e.target.closest('.blanket-card').querySelector('.quantity-input');
            let value = parseInt(input.value) || 0;
            
            if (e.target.classList.contains('minus-btn')) {
                input.value = Math.max(0, value - 1);
            } else if (e.target.classList.contains('plus-btn')) {
                input.value = value + 1;
            }
            
            updateOrderSummary();
        }

       async function handleOrderSubmission() {
    try {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) {
            alert("Please log in first");
            return;
        }

        const seller_id = user.id;
        const seller_name = user.username || "Seller";

        const distributor_id = document.getElementById('distributor-select').value;
        if (!distributor_id) {
            alert("Please select a distributor");
            return;
        }

        const customerName = document.getElementById('customer-name').value.trim();
        if (!customerName) {
            alert("Please enter customer name");
            return;
        }

        // Collect order data
        const orderData = {
            seller_id,
            distributor_id,
            customer_name: customerName,
            customer_email: document.getElementById('customer-email').value.trim(),
            customer_phone: document.getElementById('customer-phone').value.trim(),
            customer_address: document.getElementById('customer-address').value.trim(),
            priority: document.querySelector("select").value,
            instructions: document.querySelector("textarea").value.trim(),
            items: [],
            subtotal: 0,
            total: 0
        };

        let subtotal = 0;
        let hasItems = false;

        document.querySelectorAll(".blanket-card").forEach((card) => {
            const quantity = parseInt(card.querySelector(".quantity-input").value);
            if (quantity > 0) {
                hasItems = true;
                const price = parseFloat(card.querySelector(".blanket-price").dataset.price);
                const itemSubtotal = price * quantity;
                subtotal += itemSubtotal;

                const name = card.querySelector("h3").textContent;
                const blanket = blankets.find(b => b.name === name);

                if (blanket) {
                    orderData.items.push({
                        id: blanket.id,  // Fixed this line
                        quantity,
                        price,
                        subtotal: itemSubtotal
                    });
                }
            }
        });

        if (!hasItems) {
            alert("Please select at least one blanket");
            return;
        }

        orderData.subtotal = subtotal;
        orderData.total = subtotal + 200; // Shipping cost

        // Send order to backend
        const orderResponse = await fetch("http://127.0.0.1:5002/api/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderData)
        });

        const orderResult = await orderResponse.json();

        if (!orderResponse.ok) {
            alert("Error placing order: " + (orderResult.message || orderResult.error || "Unknown error"));
            return;
        }

        // Prepare notification
        const placed_on = new Date().toISOString().slice(0, 19).replace('T', ' ');
        const notificationPayload = {
            title: "New Order Received",
            message: `Order #${orderResult.order_id} placed by ${seller_name}. Subtotal: Rs.${subtotal.toFixed(2)}. Placed on: ${placed_on}`,
            distributor_id: distributor_id
        };

        // Send notification
        const notificationResponse = await fetch("http://127.0.0.1:5006/notifications", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(notificationPayload)
        });

        if (!notificationResponse.ok) {
            const notifResult = await notificationResponse.json();
            console.warn("Notification error:", notifResult.error || "Unknown error");
            alert("Order placed but notification failed.");
            return;
        }

        alert("Order placed and distributor notified successfully!");
        // Optionally reset form here

    } catch (error) {
        console.error("Submit error:", error);
        alert("Network error - please try again");
    }
}

        // Initialize the page
        document.addEventListener("DOMContentLoaded", () => {
            loadTopStockBlankets();
            loadDistributors();

            // Event listeners
            document.getElementById('view-all-blankets-btn').addEventListener('click', showAllBlanketsModal);
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                document.getElementById('all-blankets-modal').classList.add('hidden');
            });

            document.getElementById('all-blankets-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('all-blankets-modal')) {
                    document.getElementById('all-blankets-modal').classList.add('hidden');
                }
            });

            document.querySelector(".submit-order-btn").addEventListener("click", handleOrderSubmission);
        });
    </script>
</body>
</html>